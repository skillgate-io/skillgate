name: NPM Shim Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run publish dry-run only"
        required: false
        default: "true"
  push:
    tags:
      - "npm-shim-v*"

permissions:
  contents: read
  id-token: write
  attestations: write

jobs:
  npm-shim-provenance:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: npm-shim
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - name: Validate package contract
        run: |
          npm pkg get name version engines.node bin.skillgate
          npm pack --json > /tmp/npm-shim-pack.json
      - name: Verify tarball integrity metadata
        run: |
          node <<'NODE'
          const fs = require("node:fs");
          const data = JSON.parse(fs.readFileSync("/tmp/npm-shim-pack.json", "utf8"));
          if (!Array.isArray(data) || data.length !== 1) process.exit(1);
          const pack = data[0];
          if (!pack.filename || !pack.integrity || !pack.shasum) process.exit(2);
          console.log(`tarball=${pack.filename}`);
          console.log(`integrity=${pack.integrity}`);
          console.log(`shasum=${pack.shasum}`);
          NODE
      - name: Publish dry-run with provenance
        run: npm publish --access public --provenance --dry-run
      - name: Generate GitHub build provenance attestation
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "npm-shim/*.tgz"
      - name: Publish to npm registry (tag/manual non-dry-run only)
        if: >-
          ${{
            (startsWith(github.ref, 'refs/tags/npm-shim-v') ||
            (github.event_name == 'workflow_dispatch' && inputs.dry_run != 'true'))
            && secrets.NPM_TOKEN != ''
          }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public --provenance
