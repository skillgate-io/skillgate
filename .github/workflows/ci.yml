name: CI (Lightweight)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]"
      - run: ruff check .
      - run: ruff format --check .
      - run: python scripts/quality/check_wrapper_enforcement.py
      - run: python scripts/quality/check_claim_ledger.py
      - run: python scripts/quality/check_install_docs_freshness.py

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev,api]"
      - run: mypy --strict skillgate/

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev,api]"
      - run: pytest

  slo-gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev,api]"
      - name: SLO gates (false-positive rate + latency budget)
        run: pytest -m slow tests/slo/ -v

  reliability-evidence:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev,api]"
      - name: Section 14 reliability scorecard gate
        run: python scripts/quality/generate_reliability_scorecard.py

  public-export-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]"
      - name: Strict open-core public export gate
        run: python scripts/release/check_public_export.py --strict

  deployment-profile-lock:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]"
      - name: Deployment profile lock contract
        run: python scripts/quality/check_deployment_profile_lock.py

  split-ci-parity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]"
      - name: Split CI parity contract
        run: python scripts/quality/check_split_ci_parity.py

  dual-repo-release-contract:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]"
      - name: Dual-repo release contract
        run: python scripts/quality/check_dual_repo_release_contract.py

  packaging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]" setuptools setuptools-scm build twine
      - name: Packaging smoke (wheel metadata, version consistency, install)
        run: pytest -m slow tests/e2e/test_packaging_release.py -v
      - name: PyPI publish rehearsal (build artifacts + metadata validation)
        run: |
          python -m build --sdist --wheel --no-isolation --outdir dist
          python -m twine check dist/*

  api-command-matrix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev,api]"
      - name: API command matrix (SaaS/private relay/airgap)
        run: pytest tests/e2e/test_api_command_matrix.py -v


  web-ui:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web-ui
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web-ui/package-lock.json
      - run: npm ci
      - run: npm run check
      - run: npm run build

  npm-shim:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: npm-shim
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
      - name: npm shim package/provenance dry-run
        run: |
          npm pkg get name version engines.node bin.skillgate
          npm pack --json > /tmp/npm-shim-pack.json
          node <<'NODE'
          const fs = require("node:fs");
          const data = JSON.parse(fs.readFileSync("/tmp/npm-shim-pack.json", "utf8"));
          if (!Array.isArray(data) || data.length !== 1) process.exit(1);
          const pack = data[0];
          if (!pack.filename || !pack.integrity || !pack.shasum) process.exit(2);
          console.log(`tarball=${pack.filename}`);
          console.log(`integrity=${pack.integrity}`);
          console.log(`shasum=${pack.shasum}`);
          NODE
          npm publish --access public --provenance --dry-run
      - name: npm shim wrapper e2e contracts
        working-directory: .
        run: |
          pip install -e ".[dev]"
          pytest tests/e2e/test_npm_shim_wrapper.py -v

  api-migrations:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: skillgate
          POSTGRES_PASSWORD: skillgate
          POSTGRES_DB: skillgate
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U skillgate -d skillgate"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      SKILLGATE_DATABASE_URL: postgresql+asyncpg://skillgate:skillgate@localhost:5432/skillgate
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev,api]"
      - run: alembic upgrade head
      - run: alembic downgrade base
      - run: alembic upgrade head

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev,api,otel]"
      - name: Dependency vulnerability audit
        run: |
          pip install pip-audit
          python -m pip freeze --exclude-editable > /tmp/requirements-audit.txt
          pip-audit --strict -r /tmp/requirements-audit.txt
      - name: Secret detection
        run: pip install detect-secrets && detect-secrets scan --baseline .secrets.baseline || detect-secrets scan

  ga-decision-gate:
    runs-on: ubuntu-latest
    needs:
      - lint
      - typecheck
      - test
      - slo-gates
      - reliability-evidence
      - public-export-gate
      - deployment-profile-lock
      - split-ci-parity
      - dual-repo-release-contract
      - packaging
      - api-command-matrix
      - web-ui
      - npm-shim
      - api-migrations
      - security
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev,api]"
      - name: Claim ledger hard gate
        run: python scripts/quality/check_claim_ledger.py
      - name: Section 14 governance-before-autonomy + scope-freeze gate
        run: python scripts/quality/check_governance_scope_gate.py
      - name: Tier-gating proof path tests
        run: |
          pytest tests/unit/test_hunt/test_cli.py tests/unit/test_retroscan/test_cli.py -v
          pytest tests/unit/test_api/test_hunt_api.py tests/unit/test_api/test_retroscan_api.py -v
          pytest tests/unit/test_api/test_entitlements_api.py tests/unit/test_cli/test_entitlement_gates.py -v
      - name: Legal-safe launch wording and support/sales playbook gate
        run: pytest tests/docs/test_pricing_launch_controls.py -v
